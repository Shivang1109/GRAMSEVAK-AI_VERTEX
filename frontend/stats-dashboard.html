<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GramSevak AI - Analytics Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--light-bg-tint);
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--accent-green) 100%);
            color: white;
            padding: 24px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }
        
        .dashboard-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .dashboard-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-green);
        }
        
        .metric-card.highlight {
            border-left-color: var(--accent-green);
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--secondary-text);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 4px;
        }
        
        .metric-subtitle {
            font-size: 12px;
            color: var(--secondary-text);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 32px 0 16px 0;
            color: var(--primary-text);
        }
        
        .distribution-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
        }
        
        .distribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--soft-border);
        }
        
        .distribution-item:last-child {
            border-bottom: none;
        }
        
        .distribution-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .distribution-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-green);
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-text);
        }
        
        .back-link {
            display: inline-block;
            margin-top: 24px;
            padding: 12px 24px;
            background: var(--primary-green);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            transition: var(--transition);
        }
        
        .back-link:hover {
            background: var(--accent-green);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä GramSevak AI Analytics</h1>
            <p>Real-time usage statistics and performance metrics</p>
        </div>
        
        <div id="loading" class="loading">
            <p>‚è≥ Loading analytics data...</p>
        </div>
        
        <div id="error" style="display: none;"></div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Queries</div>
                    <div class="metric-value" id="total-queries">0</div>
                    <div class="metric-subtitle">All time</div>
                </div>
                
                <div class="metric-card highlight">
                    <div class="metric-label">Cache Hit Ratio</div>
                    <div class="metric-value" id="cache-hit-ratio">0%</div>
                    <div class="metric-subtitle">Offline responses</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">LLM Usage</div>
                    <div class="metric-value" id="llm-usage">0%</div>
                    <div class="metric-subtitle">AI-generated responses</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Avg Response Size</div>
                    <div class="metric-value" id="avg-bytes">0 KB</div>
                    <div class="metric-subtitle">Per query</div>
                </div>
            </div>
            
            <!-- Top Category -->
            <div class="metrics-grid">
                <div class="metric-card highlight">
                    <div class="metric-label">Top Category Today</div>
                    <div class="metric-value" id="top-category" style="font-size: 24px;">N/A</div>
                    <div class="metric-subtitle">Most queried</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Offline Mode Usage</div>
                    <div class="metric-value" id="offline-percent">0%</div>
                    <div class="metric-subtitle">Queries served offline</div>
                </div>
                
                <div class="metric-card highlight">
                    <div class="metric-label">User Satisfaction</div>
                    <div class="metric-value" id="helpful-rate">0%</div>
                    <div class="metric-subtitle">Helpful responses</div>
                </div>
            </div>
            
            <!-- Feedback Stats -->
            <h2 class="section-title">üí¨ Feedback Statistics</h2>
            <div class="distribution-card" id="feedback-stats">
                <!-- Populated by JS -->
            </div>
            
            <!-- Rate Limiting Stats -->
            <h2 class="section-title">üö´ Rate Limiting</h2>
            <div class="distribution-card" id="rate-limit-stats">
                <!-- Populated by JS -->
            </div>
            
            <!-- Category Distribution -->
            <h2 class="section-title">üìÇ Category Distribution</h2>
            <div class="distribution-card" id="category-distribution">
                <!-- Populated by JS -->
            </div>
            
            <!-- User Type Distribution -->
            <h2 class="section-title">üë• User Type Distribution</h2>
            <div class="distribution-card" id="user-type-distribution">
                <!-- Populated by JS -->
            </div>
            
            <!-- Network Breakdown -->
            <h2 class="section-title">üì° Network Type Breakdown</h2>
            <div class="distribution-card" id="network-breakdown">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <a href="index.html" class="back-link">‚Üê Back to GramSevak AI</a>
    </div>
    
    <script>
        const API_URL = 'https://gramsevak-ai-vertex-2.onrender.com';
        const ADMIN_TOKEN = 'gramsevak_admin_2024';
        
        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_URL}/analytics?token=${ADMIN_TOKEN}`);
                
                if (!response.ok) {
                    throw new Error('Unauthorized or server error');
                }
                
                const data = await response.json();
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Populate key metrics
                document.getElementById('total-queries').textContent = data.total_queries;
                document.getElementById('cache-hit-ratio').textContent = (data.cache_hit_ratio * 100).toFixed(0) + '%';
                document.getElementById('llm-usage').textContent = data.llm_usage_percent + '%';
                document.getElementById('avg-bytes').textContent = (data.avg_response_bytes / 1024).toFixed(2) + ' KB';
                document.getElementById('top-category').textContent = data.top_category;
                document.getElementById('offline-percent').textContent = data.offline_percent + '%';
                
                // Populate feedback stats
                if (data.feedback_stats) {
                    document.getElementById('helpful-rate').textContent = data.feedback_stats.helpful_rate + '%';
                    
                    const feedbackDiv = document.getElementById('feedback-stats');
                    feedbackDiv.innerHTML = `
                        <div class="distribution-item">
                            <span class="distribution-label">üìä Total Feedback</span>
                            <span class="distribution-value">${data.feedback_stats.total_feedback}</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">üëç Helpful</span>
                            <span class="distribution-value">${data.feedback_stats.helpful_count}</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">üëé Not Helpful</span>
                            <span class="distribution-value">${data.feedback_stats.not_helpful_count}</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">‚úÖ Satisfaction Rate</span>
                            <span class="distribution-value">${data.feedback_stats.helpful_rate}%</span>
                        </div>
                    `;
                }
                
                // Populate rate limit stats
                if (data.rate_limit_stats) {
                    const rateLimitDiv = document.getElementById('rate-limit-stats');
                    rateLimitDiv.innerHTML = `
                        <div class="distribution-item">
                            <span class="distribution-label">üö´ Blocked Attempts</span>
                            <span class="distribution-value">${data.rate_limit_stats.blocked_attempts}</span>
                        </div>
                        <div class="distribution-item">
                            <span class="distribution-label">üåê Active IPs</span>
                            <span class="distribution-value">${data.rate_limit_stats.active_ips}</span>
                        </div>
                    `;
                }
                
                // Populate category distribution
                const categoryDiv = document.getElementById('category-distribution');
                categoryDiv.innerHTML = '';
                
                if (Object.keys(data.category_counts).length > 0) {
                    for (const [category, count] of Object.entries(data.category_counts)) {
                        const item = document.createElement('div');
                        item.className = 'distribution-item';
                        item.innerHTML = `
                            <span class="distribution-label">${getCategoryEmoji(category)} ${category}</span>
                            <span class="distribution-value">${count} queries</span>
                        `;
                        categoryDiv.appendChild(item);
                    }
                } else {
                    categoryDiv.innerHTML = '<p style="color: var(--secondary-text); text-align: center;">No data yet</p>';
                }
                
                // Populate user type distribution
                const userTypeDiv = document.getElementById('user-type-distribution');
                userTypeDiv.innerHTML = '';
                
                if (Object.keys(data.user_type_distribution).length > 0) {
                    for (const [userType, percent] of Object.entries(data.user_type_distribution)) {
                        const item = document.createElement('div');
                        item.className = 'distribution-item';
                        item.innerHTML = `
                            <span class="distribution-label">${getUserTypeEmoji(userType)} ${userType}</span>
                            <span class="distribution-value">${percent}%</span>
                        `;
                        userTypeDiv.appendChild(item);
                    }
                } else {
                    userTypeDiv.innerHTML = '<p style="color: var(--secondary-text); text-align: center;">No data yet</p>';
                }
                
                // Populate network breakdown
                const networkDiv = document.getElementById('network-breakdown');
                networkDiv.innerHTML = '';
                
                for (const [network, count] of Object.entries(data.network_breakdown)) {
                    const item = document.createElement('div');
                    item.className = 'distribution-item';
                    item.innerHTML = `
                        <span class="distribution-label">${getNetworkEmoji(network)} ${network.toUpperCase()}</span>
                        <span class="distribution-value">${count} queries</span>
                    `;
                    networkDiv.appendChild(item);
                }
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Error loading analytics</strong><br>
                    ${error.message}<br>
                    <small>Make sure the backend is running and you have the correct token.</small>
                `;
            }
        }
        
        function getCategoryEmoji(category) {
            const emojis = {
                'government_schemes': 'üèõÔ∏è',
                'agriculture': 'üåæ',
                'health': 'üè•',
                'education': 'üìö',
                'financial': 'üí∞',
                'legal': '‚öñÔ∏è',
                'disaster': 'üö®',
                'livelihood': 'üíº',
                'general': 'üìã'
            };
            return emojis[category] || 'üìã';
        }
        
        function getUserTypeEmoji(userType) {
            const emojis = {
                'farmer': 'üåæ',
                'student': 'üìö',
                'worker': 'üíº',
                'general': 'üë§'
            };
            return emojis[userType] || 'üë§';
        }
        
        function getNetworkEmoji(network) {
            const emojis = {
                '2g': 'üì∂',
                '3g': 'üì∂',
                '4g': 'üì∂'
            };
            return emojis[network] || 'üì∂';
        }
        
        // Load analytics on page load
        loadAnalytics();
        
        // Auto-refresh every 10 seconds
        setInterval(loadAnalytics, 10000);
    </script>
</body>
</html>
